@startuml フローチャート

skinparam backgroundColor #FFFFFF
skinparam activity {
    BackgroundColor #E6F2FF
}

start
:Excelファイルのアップロード;
:HTTP POST（/api/upload）;
:リクエストからファイルを取得（req.files）;
:すべてのシートを {シート名: DataFrame} の形式で格納;

repeat :ループ処理開始;
  if (シート名が「処理詳細」の場合) then (yes)
    :シートの内容をテキストに変換;
    partition AzureOpenAI #LightBlue {
    :OpenAIに構造化をリクエスト\n（call_openai_structuring）;
    :構造化されたMDを返す;
    }
  else (no)
    :データクレンジング;
    :MDに変換;
  endif
repeat while (すべてのシート確認OK!) is (no) not (yes)

:全シートのMDを結合し、\n単一の設計書MDを作成;
partition AzureOpenAI #LightBlue {
:テスト観点抽出をリクエスト\n（call_openai_extract_test_perspectives）;
:テスト観点が明記されたMDを返す;
}
partition AzureOpenAI #LightBlue {
:テスト仕様書生成をリクエスト\n（call_openai_create_test_spec）;
:テスト仕様書MDを返す;
}
:MDをpandas DataFrameに変換;
:DataFrameをExcel形式（バイナリ）に変換;
:ブラウザにレスポンス;
:Excelファイルのダウンロード;
stop
@enduml